name: Test macOS Build

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches:
      - test-macos  # Only on test branch

permissions:
  contents: write

env:
  OPENSCAD_VERSION: "2025.01.24"

jobs:
  test-macos:
    name: Test macOS Build with OpenSCAD
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller

    - name: Clean previous builds
      run: |
        rm -rf dist build

    - name: Build with PyInstaller
      run: |
        echo "Building Qrly with PyInstaller BUNDLE (produces dist/Qrly.app)..."
        echo "Qt frameworks filtered from COLLECT, will be added manually"
        echo "Users will install OpenSCAD separately: brew install openscad"
        pyinstaller qrly.spec --clean --noconfirm
        echo "Build completed!"
        ls -la dist/

    - name: Bundle Qt frameworks
      run: |
        echo "Adding Qt frameworks to .app bundle (dereferencing symlinks)..."

        # Find PyQt6 Qt6 directory
        PYQT6_DIR=$(python -c "import PyQt6; import os; print(os.path.join(os.path.dirname(PyQt6.__file__), 'Qt6'))")
        echo "PyQt6 Qt6 directory: $PYQT6_DIR"

        # Create directory for frameworks in .app bundle
        mkdir -p dist/Qrly.app/Contents/MacOS/_internal/PyQt6/Qt6/lib

        # Copy required Qt frameworks, dereferencing symlinks (-L flag)
        echo "Copying QtCore.framework..."
        cp -RL "$PYQT6_DIR/lib/QtCore.framework" dist/Qrly.app/Contents/MacOS/_internal/PyQt6/Qt6/lib/

        echo "Copying QtWidgets.framework..."
        cp -RL "$PYQT6_DIR/lib/QtWidgets.framework" dist/Qrly.app/Contents/MacOS/_internal/PyQt6/Qt6/lib/

        echo "Copying QtGui.framework..."
        cp -RL "$PYQT6_DIR/lib/QtGui.framework" dist/Qrly.app/Contents/MacOS/_internal/PyQt6/Qt6/lib/

        echo "Copying QtDBus.framework (required by QtWidgets)..."
        cp -RL "$PYQT6_DIR/lib/QtDBus.framework" dist/Qrly.app/Contents/MacOS/_internal/PyQt6/Qt6/lib/

        echo "✓ Qt frameworks bundled successfully"
        ls -la dist/Qrly.app/Contents/MacOS/_internal/PyQt6/Qt6/lib/

    - name: Verify app structure
      run: |
        echo "Verifying PyInstaller-created Qrly.app structure..."
        ls -la dist/Qrly.app/Contents/
        echo ""
        echo "Checking MacOS directory:"
        ls -la dist/Qrly.app/Contents/MacOS/ | head -10
        echo ""
        echo "Checking _internal directory:"
        ls -la dist/Qrly.app/Contents/MacOS/_internal/ | head -10
        echo ""
        echo "Checking Python.framework:"
        ls -la dist/Qrly.app/Contents/MacOS/_internal/Python.framework/Versions/
        echo ""
        echo "Checking Resources:"
        ls -la dist/Qrly.app/Contents/Resources/ || echo "No Resources directory"

    - name: Create DMG installer
      run: |
        brew install create-dmg

        mkdir -p dist/dmg
        cp -R dist/Qrly.app dist/dmg/

        # Create DMG
        create-dmg \
          --volname "Qrly Test Installer" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "Qrly.app" 200 190 \
          --hide-extension "Qrly.app" \
          --app-drop-link 600 185 \
          "dist/Qrly-test-macOS.dmg" \
          "dist/dmg/" || \
        hdiutil create -volname "Qrly Test" -srcfolder dist/dmg -ov -format UDZO \
          "dist/Qrly-test-macOS.dmg"

        echo "✓ DMG created!"
        ls -lh dist/Qrly-test-macOS.dmg

    - name: Upload DMG as artifact
      uses: actions/upload-artifact@v4
      with:
        name: Qrly-test-macOS
        path: dist/Qrly-test-macOS.dmg
        retention-days: 7

    - name: Upload full app bundle as artifact
      uses: actions/upload-artifact@v4
      with:
        name: Qrly-app-bundle
        path: dist/Qrly.app
        retention-days: 7
